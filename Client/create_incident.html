<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Incident - SportsPro Technical Support</title>
    <link rel="stylesheet" href="css/main.css" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="container">
        <h1>SportsPro Technical Support</h1>
        <p>Sports management software for the sports enthusiast</p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container">
      <div class="main-panel">
        <div class="header-section">
          <h2>Create Incident</h2>
          <a href="index.html">Home</a>
        </div>

        <!-- Create Incident Form -->
        <div class="form-panel">
          <form id="incidentForm">
            <div class="form-row">
              <div class="form-group">
                <label for="customer">Customer:</label>
                <select id="customer" name="customerid" required>
                  <option value="">-- Select a Customer --</option>
                  <!-- Customers will be loaded dynamically -->
                </select>
              </div>

              <div class="form-group">
                <label for="product">Product:</label>
                <select id="product" name="productcode" required>
                  <option value="">-- Select a Product --</option>
                  <!-- Products will be loaded dynamically -->
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="title">Title:</label>
              <input
                type="text"
                id="title"
                name="title"
                placeholder="Brief description of the issue"
                required
              />
            </div>

            <div class="form-group">
              <label for="description">Description:</label>
              <textarea
                id="description"
                name="description"
                rows="4"
                placeholder="Detailed description of the incident"
                required
              ></textarea>
            </div>

            <button type="submit" class="btn btn-primary">
              Create Incident
            </button>
          </form>
        </div>

        <!-- Confirmation Message (Initially hidden) -->
        <div id="successPanel" class="success-panel hidden">
          <div class="alert alert-success">
            <p id="successMessage">Incident was successfully created.</p>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer>
      <div class="container">
        <p>&copy; 2025 SportsPro, Inc.</p>
      </div>
    </footer>

    <script>
      const incidentForm = document.getElementById("incidentForm");
      const customerSelect = document.getElementById("customer");
      const productSelect = document.getElementById("product");
      const successPanel = document.getElementById("successPanel");
      const successMessage = document.getElementById("successMessage");

      const INCIDENTS_API = "http://localhost:8000/api/incident";
      const CUSTOMERS_API = "http://localhost:8000/api/customers";
      const PRODUCTS_API = "http://localhost:8000/api/products";

      const token = localStorage.getItem("token");
      const userRole = localStorage.getItem("userRole");
      const userId = localStorage.getItem("userId");

      if (!token) {
        alert("You are not authenticated. Please login first.");
        window.location.href = "login.html";
      }

      const authHeaders = {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      };

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          if (userRole !== "customer") {
            alert("Only customers can create incidents");
            window.location.href = "index.html";
            return;
          }

          await Promise.all([loadCustomers(), loadProducts()]);
        } catch (error) {
          console.error("Error loading initial data:", error);
          alert("Error loading required data. Please try again later.");
        }
      });

      function handleUnauthorized() {
        alert("Your session has expired. Please login again.");
        localStorage.removeItem("token");
        localStorage.removeItem("userRole");
        localStorage.removeItem("user");
        window.location.href = "login.html";
      }

      async function loadCustomers() {
        try {
          const response = await fetch(CUSTOMERS_API, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.status === 401) {
            handleUnauthorized();
            return;
          }

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "Failed to fetch customers");
          }

          const customersData = await response.json();
          const customers = customersData.data;
          renderCustomers(customers);
        } catch (error) {
          console.error("Error loading customers:", error);
          throw error;
        }
      }

      function renderCustomers(customers) {
        customerSelect.innerHTML =
          '<option value="">-- Select a Customer --</option>';

        if (userRole === "customer") {
          const currentCustomer = customers.find((c) => c.customerid == userId);
          if (currentCustomer) {
            const option = document.createElement("option");
            option.value = currentCustomer.customerid;
            option.textContent = `${currentCustomer.firstname} ${currentCustomer.lastname} (${currentCustomer.email})`;
            option.selected = true;
            customerSelect.appendChild(option);
            customerSelect.disabled = true;
          }
        } else {
          customers.forEach((customer) => {
            const option = document.createElement("option");
            option.value = customer.customerid;
            option.textContent = `${customer.firstname} ${customer.lastname} (${customer.email})`;
            customerSelect.appendChild(option);
          });
        }
      }

      async function loadProducts() {
        try {
          const response = await fetch(PRODUCTS_API, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.status === 401) {
            handleUnauthorized();
            return;
          }

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "Failed to fetch products");
          }

          const products = await response.json();
          renderProducts(products);
        } catch (error) {
          console.error("Error loading products:", error);
          throw error;
        }
      }

      function renderProducts(products) {
        productSelect.innerHTML =
          '<option value="">-- Select a Product --</option>';

        products.forEach((product) => {
          const option = document.createElement("option");
          option.value = product.productcode;
          option.textContent = `${product.name} (${product.productcode})`;
          productSelect.appendChild(option);
        });
      }

      incidentForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (userRole !== "customer") {
          alert("Only customers can create incidents");
          return;
        }

        const formData = {
          customerID: incidentForm.customerid.value,
          productCode: incidentForm.productcode.value,
          title: incidentForm.title.value.trim(),
          description: incidentForm.description.value.trim(),
        };

        if (
          !formData.customerID ||
          !formData.productCode ||
          !formData.title ||
          !formData.description
        ) {
          alert("Please fill in all required fields");
          return;
        }

        try {
          const response = await fetch(INCIDENTS_API, {
            method: "POST",
            headers: authHeaders,
            body: JSON.stringify(formData),
          });

          if (response.status === 401) {
            handleUnauthorized();
            return;
          }

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || "Failed to create incident");
          }

          successMessage.textContent = `Incident was successfully created with ID #${result.incidentID}.`;
          successPanel.classList.remove("hidden");

          incidentForm.title.value = "";
          incidentForm.description.value = "";
          productSelect.value = "";

          successPanel.scrollIntoView({ behavior: "smooth" });
        } catch (error) {
          console.error("Error creating incident:", error);
          alert(`Error creating incident: ${error.message}`);
        }
      });
    </script>
  </body>
</html>
