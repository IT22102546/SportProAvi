<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Products - SportsPro Technical Support</title>
    <link rel="stylesheet" href="css/main.css" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="container">
        <h1>SportsPro Technical Support</h1>
        <p>Sports management software for the sports enthusiast</p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container">
      <div class="main-panel">
        <div class="header-section">
          <h2>Product List</h2>
          <a href="index.html">Home</a>
        </div>

        <!-- Product Table -->
        <div class="table-container mb-4">
          <table id="productsTable">
            <thead>
              <tr>
                <th>Code</th>
                <th>Name</th>
                <th>Version</th>
                <th>Release Date</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Products will be loaded dynamically -->
            </tbody>
          </table>
        </div>

        <!-- Add Product Form -->
        <div class="form-panel">
          <h3>Add Product</h3>
          <form id="addProductForm">
            <div class="form-group">
              <label for="code">Code:</label>
              <input type="text" id="code" name="productCode" required />
            </div>

            <div class="form-group">
              <label for="name">Name:</label>
              <input type="text" id="name" name="name" required />
            </div>

            <div class="form-group">
              <label for="version">Version:</label>
              <input
                type="number"
                id="version"
                name="version"
                step="0.1"
                required
              />
            </div>

            <div class="form-group">
              <label for="releaseDate">Release Date:</label>
              <input type="date" id="releaseDate" name="releaseDate" required />
            </div>

            <button type="submit" class="btn btn-primary">Add Product</button>
          </form>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer>
      <div class="container">
        <p>&copy; 2025 SportsPro, Inc.</p>
      </div>
    </footer>

    <script>
      const productsTable = document
        .getElementById("productsTable")
        .getElementsByTagName("tbody")[0];
      const addProductForm = document.getElementById("addProductForm");

      const API_BASE_URL = "http://localhost:8000/api/products";

      const token = localStorage.getItem("token");
      if (!token) {
        alert("You are not authenticated. Please login first.");
        window.location.href = "login.html";
      }

      const authHeaders = {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      };

      document.addEventListener("DOMContentLoaded", loadProducts);

      addProductForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = {
          productCode: addProductForm.productCode.value,
          name: addProductForm.name.value,
          version: parseFloat(addProductForm.version.value),
          releaseDate: addProductForm.releaseDate.value,
        };

        try {
          const response = await fetch(API_BASE_URL, {
            method: "POST",
            headers: authHeaders,
            body: JSON.stringify(formData),
          });

          if (response.status === 401) {
            handleUnauthorized();
            return;
          }

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "Failed to add product");
          }

          addProductForm.reset();
          loadProducts();

          alert("Product added successfully!");
        } catch (error) {
          console.error("Error adding product:", error);
          alert(error.message || "Error adding product. Please try again.");
        }
      });

      async function loadProducts() {
        try {
          const response = await fetch(API_BASE_URL, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.status === 401) {
            handleUnauthorized();
            return;
          }

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "Failed to fetch products");
          }

          const products = await response.json();
          renderProducts(products);
        } catch (error) {
          console.error("Error loading products:", error);
          alert(error.message || "Error loading products. Please try again.");
        }
      }

      function renderProducts(products) {
        productsTable.innerHTML = "";

        if (products.length === 0) {
          const row = productsTable.insertRow();
          const cell = row.insertCell(0);
          cell.colSpan = 5;
          cell.textContent = "No products found";
          cell.style.textAlign = "center";
          return;
        }

        products.forEach((product) => {
          const row = productsTable.insertRow();

          row.insertCell(0).textContent = product.productcode;
          row.insertCell(1).textContent = product.name;
          row.insertCell(2).textContent = product.version;

          const dateCell = row.insertCell(3);
          dateCell.textContent = product.releasedate
            ? product.releasedate.split("T")[0]
            : "N/A";

          const actionCell = row.insertCell(4);
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "btn btn-danger";
          deleteBtn.textContent = "Delete";
          deleteBtn.addEventListener("click", () =>
            confirmDelete(product.productcode)
          );
          actionCell.appendChild(deleteBtn);
        });
      }

      async function confirmDelete(productCode) {
        if (
          confirm(`Are you sure you want to delete product ${productCode}?`)
        ) {
          try {
            const response = await fetch(`${API_BASE_URL}/${productCode}`, {
              method: "DELETE",
              headers: authHeaders,
            });

            if (response.status === 401) {
              handleUnauthorized();
              return;
            }

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || "Failed to delete product");
            }

            loadProducts();
            alert("Product deleted successfully!");
          } catch (error) {
            console.error("Error deleting product:", error);
            alert(error.message || "Error deleting product. Please try again.");
          }
        }
      }

      function handleUnauthorized() {
        alert("Your session has expired. Please login again.");
        localStorage.removeItem("token");
        localStorage.removeItem("userRole");
        localStorage.removeItem("user");
        window.location.href = "login.html";
      }
    </script>
  </body>
</html>
